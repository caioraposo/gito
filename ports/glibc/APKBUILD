# Contributor: Franklin Sobrinho <franklin.g.sobrinho@gmail.com>
# Maintainer: Frankln Sobrinho <franklin.g.sobrinho@gmail.com>

pkgname=glibc
pkgver=2.29
pkgrel=0
pkgdesc="The GNU libc implementation"
url="https://www.gnu.org/software/libc/"
arch="all"
license="LGPL"
makedepends="linux-headers texinfo bash coreutils gawk sed bison perl python3 py3-pexpect"
options="!tracedeps !checkroot"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-lang-minimal:lang_minimal:noarch
	$pkgname-locale-src:locale_src:noarch
	"
source="
	http://ftpmirror.gnu.org/libc/glibc-$pkgver.tar.xz
	glibc-c-utf8-locale.patch
	glibc-locale-gen
	"

builddir="$srcdir"/$pkgname-$pkgver

build() {
	cd "$builddir"

	mkdir glibc-build/ glibc-locale/

	cd "$builddir"/glibc-build
	"$builddir"/configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/compat \
		--libdir=/compat/lib \
		--libexecdir=/compat/lib \
		--sysconfdir=/compat/etc \
		--includedir=/compat/usr/include \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-headers=/usr/include \
		--enable-bind-now \
		--enable-mutli-arch \
		--enable-stack-protector=strong \
		--enable-stackguard-randomization \
		--enable-static-pie \
		--disable-profile \
		--disable-werror
	make

	# Generate locale data on build() as localedef won't work
	# on package(), because of fakeroot

	cd "$builddir"

	# Generate locale-archive for C.UTF-8 locale
	mv localedata/SUPPORTED localedata/SUPPORTED.old
	cat <<-EOF > localedata/SUPPORTED
		SUPPORTED-LOCALES=C.UTF-8/UTF-8
	EOF
	make DESTDIR="$builddir"/glibc-locale \
		objdir="$builddir"/glibc-build install-locales -C localedata/
	mv localedata/SUPPORTED.old localedata/SUPPORTED
}

package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install -C glibc-build/

	cp "$srcdir"/glibc-locale-gen "$pkgdir"/compat/bin

	case "$CARCH" in
		aarch64)	_ld="lib/ld-linux-aarch64.so.1" ;;
		armel)		_ld="lib/ld-linux.so.3" ;;
		armhf)		_ld="lib/ld-linux-armhf.so.3" ;;
		armv7)		_ld="lib/ld-linux-armhf.so.3" ;;
		mips)		_ld="lib/ld.so.1" ;;
		mips64)		_ld="lib64/ld.so.1" ;;
		mipsel)		_ld="lib/ld.so.1" ;;
		mips64el)	_ld="lib64/ld.so.1" ;;
		ppc)		_ld="lib/ld.so.1" ;;
		ppc64)		_ld="lib64/ld64.so.1" ;;
		ppc64le)	_ld="lib64/ld64.so.2" ;;
		s390x)		_ld="lib/ld64.so.1" ;;
		x86)		_ld="lib/ld-linux.so.2" ;;
		x86_64)		_ld="lib64/ld-linux-x86-64.so.2" ;;
	esac

	mkdir -p "$pkgdir"/${_ld%/*}
	ln -sf "/compat/lib/${_ld#*/}" "$pkgdir/$_ld"

	rm "$pkgdir"/compat/etc/ld.so.cache
}

dev() {
	pkgdir="$pkgdir"/compat default_dev

	cd "$subpkgdir"
	for i in */; do
		mkdir -p compat
		mv "$i" compat/"$i"
	done
}

lang_minimal() {
	description="GNU libc: Precompiled locale data for C.UTF-8"
	cp -r "$builddir"/glibc-locale "$subpkgdir"
}

locale_src() {
	mkdir -p "$subpkgdir"/compat/share
	mv "$pkgdir"/compat/share/i18n "$subpkgdir"/compat/share
}

check() {
	cd "$builddir"/glibc-build

	echo "CFLAGS=" >> configparms
	echo "CPPFLAGS-config=" >> configparms

	make check
}

sha512sums="146bc0769fe853d9edbf93cea7f74c5b3d84d69cb7614c62588e7acdecd1ec789a9d8949f3e8b99f8f36f2ccac740a003bed94f32b07817baf780b06cfeb6ed0  glibc-2.29.tar.xz
9ea1eeea7a9c1b35453b571aef91ae82329190d2d77372282ea0f3837e5e5a0e1b3c2a0a79c122c8884956b795c37d71d3e3c931fd62dc6fca5582186f618746  glibc-c-utf8-locale.patch
d856f3ad7024119ef2070984202a62d2392e42cde30fbe93bddf7e01fecda8cab0e3a386700450819928b7ae1dfd7c80f93689a8c6ac4f327945b8e4f780a7cf  glibc-locale-gen"
