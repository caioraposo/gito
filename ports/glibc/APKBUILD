# Contributor: Franklin Sobrinho <franklin.g.sobrinho@gmail.com>
# Maintainer: Frankln Sobrinho <franklin.g.sobrinho@gmail.com>

pkgname=glibc
pkgver=2.29
pkgrel=0
pkgdesc="The GNU libc implementation"
url="https://www.gnu.org/software/libc/"
arch="all"
license="LGPL"
makedepends="linux-headers texinfo bash gawk sed bison perl python3 py3-pexpect"
options="!tracedeps"
subpackages="$pkgname-dev $pkgname-doc $pkgname-dbg"
source="http://ftpmirror.gnu.org/libc/glibc-$pkgver.tar.xz"

builddir="$srcdir"/$pkgname-$pkgver

build() {
	cd "$builddir"

	mkdir glibc-build/
	cd glibc-build/

	"$builddir"/configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/compat \
		--libdir=/compat/lib \
		--libexecdir=/compat/lib \
		--sysconfdir=/compat/etc \
		--includedir=/compat/usr/include \
		--mandir=/compat/usr/share/man \
		--infodir=/compat/usr/share/info \
		--with-headers=/usr/include \
		--enable-bind-now \
		--enable-lock-elision \
		--enable-mutli-arch \
		--enable-stack-protector=strong \
		--enable-stackguard-randomization \
		--enable-static-pie
	make
}

package() {
	cd "$builddir"

	cd glibc-build/
	make DESTDIR="$pkgdir" install

	case "$CARCH" in
		aarch64)	_ld="lib/ld-linux-aarch64.so.1" ;;
		armel)		_ld="lib/ld-linux.so.3" ;;
		armhf)		_ld="lib/ld-linux-armhf.so.3" ;;
		armv7)		_ld="lib/ld-linux-armhf.so.3" ;;
		mips)		_ld="lib/ld.so.1" ;;
		mips64)		_ld="lib64/ld.so.1" ;;
		mipsel)		_ld="lib/ld.so.1" ;;
		mips64el)	_ld="lib64/ld.so.1" ;;
		ppc)		_ld="lib/ld.so.1" ;;
		ppc64)		_ld="lib64/ld64.so.1" ;;
		ppc64le)	_ld="lib64/ld64.so.2" ;;
		s390x)		_ld="lib/ld64.so.1" ;;
		x86)		_ld="lib/ld-linux.so.2" ;;
		x86_64)		_ld="lib64/ld-linux-x86-64.so.2" ;;
	esac

	_ld_file="${_ld#*/}"

	mkdir -p "$pkgdir"/${_ld%/*} "$pkgdir"/lib/
	ln -sf "/compat/lib/$_ld_file" "$pkgdir/$_ld"
	ln -sf "/compat/lib/$_ld_file" "$pkgdir/lib/$_ld_file"
}

_mv2compat() {
	cd "$subpkgdir"
	for i in */; do
		mkdir -p compat
		mv "$i" compat/"$i"
	done
}

dev() {
	pkgdir="$pkgdir"/compat default_dev
	_mv2compat
}

doc() {
	pkgdir="$pkgdir"/compat default_doc
	_mv2compat
}

check() {
	cd "$builddir"
	
	cd glibc-build/
	make check || true
}

sha512sums="146bc0769fe853d9edbf93cea7f74c5b3d84d69cb7614c62588e7acdecd1ec789a9d8949f3e8b99f8f36f2ccac740a003bed94f32b07817baf780b06cfeb6ed0  glibc-2.29.tar.xz"
