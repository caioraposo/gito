#!/bin/sh

apk_server_run() {
	if ! gitobld-docker -qet network $GITOBLD_NETWORK; then
		echo "Creating '$GITOBLD_NETWORK' network..."

		gitobld-docker -qct network $GITOBLD_NETWORK
		export GITOBLD_NETWORK
		gitobld-env -w
	fi

	gitobld-docker -be $rebuild_image_opt $APK_SERVER_IMAGE build/apk-server

	runargs="--detach"
	http_root=/app/apk_server

	[ -n "$PKG_PUBKEY_PATH" ] &&
		runargs="$runargs --mount type=bind,src=$PKG_PUBKEY_PATH,dst=$http_root/${PKG_PUBKEY_PATH##*/},readonly"

	[ -n "$GITOBLD_NETWORK" ] && runargs="$runargs --network $GITOBLD_NETWORK"

	if [ -n "$REPOSITORY_PATH" ]; then
		runargs="$runargs --mount type=bind,src=$(gitobld-realpath $REPOSITORY_PATH),dst=$http_root/packages,readonly"
	else
		runargs="$runargs --mount src=$GITOBLD_VOLUME,dst=$http_root/packages,readonly"
	fi

	gitobld-docker -xe $force_recreate_opt "$APK_SERVER_HOST" $runargs "$APK_SERVER_IMAGE"
	APK_SERVER_CONTAINER=$(gitobld-docker -it container $APK_SERVER_HOST)

	export APK_SERVER_CONTAINER
	gitobld-env -w
}

apk_server_stop() {
	container_id=$(gitobld-docker -it container "$APK_SERVER_HOST")

	if [ -n "$container_id" ] ; then
		echo "Stopping container '"$APK_SERVER_HOST"'..."
		gitobld-docker -qs stopped "$container_id"
	fi
}

apk_server_delete() {
	container_id=$(gitobld-docker -it container "$APK_SERVER_HOST")

	if [ -n "$container_id" ]; then
		gitobld-docker -def $container_id
	fi

}

APK_SERVER_IMAGE=${APK_SERVER_IMAGE:-gitobioinformatics/apk-server}
APK_SERVER_HOST=${APK_SERVER_HOST:-gitobld-apk-server.local}

PKG_PUBKEY_PATH=${PKG_PUBKEY_PATH:-$PWD/keys/packager_key.rsa.pub}

GITOBLD_VOLUME=${GITOBLD_VOLUME:-gitobld-volume}
GITOBLD_NETWORK=${GITOBLD_NETWORK:-gitobld-network}

while getopts "bcdrs" opt; do
	case $opt in
		b) rebuild_image_opt='-f' ;;
		c) force_recreate_opt='-f' ;;
		d) command_opt='-d' ;;
		r) command_opt='-r' ;;
		s) command_opt='-s' ;;
	esac
done

shift $((OPTIND-1))

command_opt=${command_opt:-'-r'}

case $command_opt in
	'-d') apk_server_delete ;;
	'-r') apk_server_run ;;
	'-s') apk_server_stop ;;
esac

