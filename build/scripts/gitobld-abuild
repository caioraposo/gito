#!/bin/sh

abuild_exec() {
	# TODO: Change to container id.

	if [ -n "$BUILD_OUTPUT_DIR" ]; then
		_userid="$(id -u):$(id -g)"
	else
		_userid="abuild"
	fi

	docker exec \
		--interactive --tty \
		--user $_userid \
		$ABUILD_CONTAINER_NAME $@
}

abuild_run() {
	if [ -z "$BUILD_OUTPUT_DIR" ] && ! gitobld-docker -qet volume $GITOBLD_VOLUME; then
		echo "Creating '$GITOBLD_VOLUME' volume..."

		gitobld-docker -qct volume $GITOBLD_VOLUME
		export GITOBLD_VOLUME
		gitobld-env -w
	fi

	gitobld-docker -b $ABUILD_IMAGE build/abuild

	if ! gitobld-docker -x $ABUILD_CONTAINER; then
		gitobld-docker -qde $ABUILD_CONTAINER

		_workdir=/var/lib/abuild
		_repodest_dir="$_workdir"/packages
		_aports_dir="$_workdir"/aports

		_run_args=""

		if [ -n "$BUILD_OUTPUT_DIR" ]; then
			_run_args="
				$_run_args
				--user $(id -u):$(id -g)
				--group-add abuild
				--mount type=bind,src=$(gitobld-realpath $BUILD_OUTPUT_DIR),dst=$_repodest_dir
				"
		else
			_run_args="$_run_args --mount src=$GITOBLD_VOLUME,dst=$_repodest_dir"
		fi

		echo "Creating '$ABUILD_CONTAINER_NAME' container..."

		docker run \
			--detach \
			--name $ABUILD_CONTAINER_NAME \
			--env APORTS_DIR=$_aports_dir \
			--mount type=bind,src=$PKG_DIRECTORY,dst=$_aports_dir,readonly \
			--mount type=bind,src=$PKG_PRIVKEY_PATH,dst=$_workdir/keys/${PKG_PRIVKEY_PATH##*/},readonly \
			--mount type=bind,src=$PKG_PUBKEY_PATH,dst=/etc/apk/keys/${PKG_PUBKEY_PATH##*/},readonly \
			$_run_args \
			$ABUILD_IMAGE tail -f /dev/null > /dev/null 2>&1

		ABUILD_CONTAINER=$(gitobld-docker -it container $ABUILD_CONTAINER_NAME)

		export ABUILD_CONTAINER
		gitobld-env -w
	fi
}

abuild_stop() {
	[ -z "$ABUILD_CONTAINER" ] && return 1

	echo "Stopping container '"$ABUILD_CONTAINER"'..."
	gitobld-docker -qs stopped $ABUILD_CONTAINER
}

ABUILD_IMAGE=${APK_SERVER_IMAGE:-gitobioinformatics/abuild}
ABUILD_CONTAINER_NAME=${ABUILD_CONTAINER_NAME:-gitobld-abuild}

PKG_DIRECTORY=${PKG_DIRECTORY:-$PWD/ports}

PKG_PRIVKEY_PATH=${PKG_PRIVKEY_PATH:-$PWD/keys/packager_key.rsa}
PKG_PUBKEY_PATH=${PKG_PUBKEY_PATH:-$PKG_PRIVKEY_PATH.pub}

GITOBLD_VOLUME=${GITOBLD_VOLUME:-gitobld-volume}

opt=${1:-'-r'}

[ "$#" -gt 0 ] && shift

case $opt in
	-e) abuild_exec $@ ;;
	-r) abuild_run ;;
	-s) abuild_stop ;;
esac

