#!/bin/sh

abuild_exec() {
	docker exec \
		--interactive --tty \
		--user $_userid \
		$ABUILD_CONTAINER $@

	apk-build $_apk_build_args $_apk_name
}

abuild_run() {
	if [ -z "$BUILD_OUTPUT_DIR" ] && ! gitobld-docker -qet volume $GITOBLD_VOLUME; then
		msg "Creating '$GITOBLD_VOLUME' volume..."
		#docker volume create $GITOBLD_VOLUME > /dev/null 2>&1
		gitobld-docker -qct network $GITOBLD_VOLUME
		gitobld-env -w
	fi

	gitobld-docker -b $ABUILD_IMAGE build/abuild

	if ! gitobld-docker -x $ABUILD_CONTAINER; then
		gitobld-docker -qde $ABUILD_CONTAINER

		_workdir=/var/lib/abuild
		_repodest_dir="$_workdir"/packages
		_aports_dir="$_workdir"/aports

		_run_args=""

		if [ -n "$BUILD_OUTPUT_DIR" ]; then
			_run_args="
				$_run_args
				--user $(id -u):$(id -g)
				--group-add abuild
				--mount type=bind,src=$(gitobld-realpath $BUILD_OUTPUT_DIR),dst=$_repodest_dir
				"
		else
			_run_args="$_run_args --mount src=$GITOBLD_VOLUME,dst=$_repodest_dir"
		fi

		msg "Creating '$ABUILD_CONTAINER_NAME' container..."

		docker run \
			--detach \
			--name $ABUILD_CONTAINER_NAME \
			--env APORTS_DIR=$_aports_dir \
			--mount type=bind,src=$PKG_DIRECTORY,dst=$_aports_dir,readonly \
			--mount type=bind,src=$PKG_PRIVKEY_PATH,dst=$_workdir/keys/${PKG_PRIVKEY_PATH##*/},readonly \
			--mount type=bind,src=$PKG_PUBKEY_PATH,dst=/etc/apk/keys/${PKG_PUBKEY_PATH##*/},readonly \
			$_run_args \
			$ABUILD_IMAGE tail -f /dev/null

		ABUILD_CONTAINER=$(gitobld-docker -it container $ABUILD_CONTAINER_NAME)
		gitobld-env -w
	fi
}

abuild_stop() {
	[ -z "$ABUILD_CONTAINER" ] && return 1

	msg "Stopping container '"$ABUILD_CONTAINER"'..."
	gitobld-docker -qs stopped $ABUILD_CONTAINER
}

opt=${1:-'-r'}

case $opt in
	-e) abuild_exec "$@" ;;
	-r) run_abuild ;;
	-s) stop_abuild ;;
esac

