#!/bin/sh

build_tool_image() {
	_tool_name=$1
	_tool_tag=$(gitobld-library -t $_tool_name)

	if [ -z "$_tool_tag" ]; then
		#error "Invalid tool name '$_tool_name'"
		echo "Invalid tool name '$_tool_name'"
		return 1
	fi

	if ! gitobld-library -e $_tool_name; then
		#error "No tool with '$_tool_name' name at library directory."
		echo "No tool with '$_tool_name' name at library directory."
		return 1
	fi

	_build_args="--tag $_tool_tag"

	[ -n "$BUILD_NO_CACHE" ] && _build_args="$_build_args --no-cache"
	
	[ -n "$GITOBLD_NETWORK" ] && _build_args="$_build_args --network $GITOBLD_NETWORK"

	[ -n "$PKG_REPOSITORY" ] && _build_args="$_build_args --build-arg PKG_REPOSITORY=$PKG_REPOSITORY"
	[ -n "$PKG_PUBKEY_URL" ] && _build_args="$_build_args --build-arg PKG_PUBKEY_URL=$PKG_PUBKEY_URL"

	docker build $_build_args library/"$_tool_name"
}

APK_SERVER_HOST=${APK_SERVER_HOST:-gitobld_apk_server.local}

PKG_REPOSITORY=${PKG_REPOSITORY:-http://"$APK_SERVER_HOST"/packages/aports}

PKG_PUBKEY_PATH=${PKG_PUBKEY_PATH:-$PWD/keys/packager_key.rsa.pub}
PKG_PUBKEY_URL='http://'"$APK_SERVER_HOST"'/'"${PKG_PUBKEY_PATH##*/}"

GITOBLD_NETWORK=${GITOBLD_NETWORK:-gitobld-network}

build_tool_image "$1"

