#!/bin/sh

set -e

. ${GITOBLD_COMMON:-true}

abuild_run() {
	if [ -z "$BUILD_OUTPUT_DIR" ] && ! gitobld-docker -qet volume "$GITOBLD_VOLUME"; then
		msg "Creating '$GITOBLD_VOLUME' volume..."
		gitobld-docker -qct volume "$GITOBLD_VOLUME"
	fi

	gitobld-docker -be $rebuild_image_opt "$ABUILD_IMAGE" build/abuild

	repodest=/app/packages
	aportsdir=/app/aports

	runargs="--interactive --tty --rm"

	if [ -n "$RUN_AS_USER" ] && [ "$RUN_AS_USER" != 'abuild' ]; then
		runargs="$runargs --group-add abuild"
	fi

	if [ -n "$BUILD_OUTPUT_DIR" ]; then
		runargs="$runargs --mount type=bind,src=$BUILD_OUTPUT_DIR,dst=$repodest"
	else
		runargs="$runargs --mount src=$GITOBLD_VOLUME,dst=$repodest"
	fi

	runargs="
		$runargs
		--mount type=bind,src=$PKG_DIRECTORY,dst=$aportsdir,readonly
		--mount type=bind,src=$PKG_PRIVKEY_PATH,dst=/app/keys/${PKG_PRIVKEY_PATH##*/},readonly
		--mount type=bind,src=$PKG_PUBKEY_PATH,dst=/etc/apk/keys/${PKG_PUBKEY_PATH##*/},readonly
		"

	if [ "$#" -eq 0 ]; then
		set -- tail -f /dev/null
	fi

	gitobld-docker -xe $force_recreate_opt "$ABUILD_CONTAINER_NAME" $runargs "$ABUILD_IMAGE" $@
}

usage() {
	cat <<-EOF
		Usage: $program [-d PKG_DIRECTORY] PACKAGE...
		
		Build a Alpine package

		Options:
		    -b  Rebuild 'abuild' image
		    -c  Recreate containers
		    -d  Search for apks on this directory
		    -h  Show this help
		    -k  Set path to packager private key
		    -o  Set output directory
		    -p  Set path to packager public key
		    -R  Build APKBUILD depencies
		    -U  Run container with this user
	EOF

	exit 0
}

while getopts "bcd:hk:o:p:RU:" opt; do
	case $opt in
		b) rebuild_image_opt='-f' ;;
		c) force_recreate_opt='-f' ;;
		d) PKG_DIRECTORY=$OPTARG ;;
		h) usage ;;
		k) PKG_PRIVKEY_PATH=$OPTARG ;;
		o) BUILD_OUTPUT_DIR=$OPTARG ;;
		p) PKG_PUBKEY_PATH=$OPTARG ;;
		R) build_deps_opt='-R' ;;
		U) RUN_AS_USER=$OPTARG ;;
	esac
done

shift $((OPTIND-1))

if [ "$#" -eq 0 ]; then
	die "No packages passed to '$program' command."
fi

[ "$1" = all ] && set -- $(gitobld-library -a)

ABUILD_IMAGE=${APK_SERVER_IMAGE:-gitobioinformatics/abuild}
ABUILD_CONTAINER_NAME=${ABUILD_CONTAINER_NAME:-gitobld-abuild}

PKG_DIRECTORY=${PKG_DIRECTORY:-$PWD/ports}

PKG_PRIVKEY_PATH=${PKG_PRIVKEY_PATH:-$PWD/keys/packager_key.rsa}
PKG_PUBKEY_PATH=${PKG_PUBKEY_PATH:-$PKG_PRIVKEY_PATH.pub}

RUN_AS_USER=${RUN_AS_USER:-"$(id -u):$(id -g)"}

GITOBLD_VOLUME=${GITOBLD_VOLUME:-gitobld-volume}

export RUN_AS_USER

for pkg in $@; do
	if ! gitobld-ports -e "$pkg"; then
		error "The package '$pkg' don't exists at ports directory."
		return 1
	fi
done

msg "Building packages..."
abuild_run apk-build -t $build_deps_opt $@

