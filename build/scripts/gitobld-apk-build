#!/bin/sh

set -e

if [ -f "$GITOBLD_COMMON" ]; then
	. "$GITOBLD_COMMON"
fi

abuild_run() {
	if [ -z "$BUILD_OUTPUT_DIR" ] && ! gitobld-docker -qet volume "$GITOBLD_VOLUME"; then
		msg "Creating '$GITOBLD_VOLUME' volume..."
		gitobld-docker -qct volume "$GITOBLD_VOLUME"
	fi

	gitobld-docker -be $rebuild_image_opt "$ABUILD_IMAGE" build/abuild

	repodest=/app/packages
	aportsdir=/app/"$(basename $PKG_DIRECTORY)"

	runargs="--interactive --tty --rm"

	if [ -n "$RUN_AS_USER" ] && [ "$RUN_AS_USER" != 'abuild' ]; then
		runargs="$runargs --group-add abuild"
	fi

	if [ -n "$BUILD_OUTPUT_DIR" ]; then
		runargs="$runargs --mount type=bind,src=$BUILD_OUTPUT_DIR,dst=$repodest"
	else
		runargs="$runargs --mount src=$GITOBLD_VOLUME,dst=$repodest"
	fi

	runargs="
		$runargs
		--mount type=bind,src=$PKG_DIRECTORY,dst=$aportsdir,readonly
		--mount type=bind,src=$PKG_PRIVKEY_PATH,dst=/app/keys/${PKG_PRIVKEY_PATH##*/},readonly
		--mount type=bind,src=$PKG_PUBKEY_PATH,dst=/etc/apk/keys/${PKG_PUBKEY_PATH##*/},readonly
		"

	runargs="$runargs --env APORTSDIR=$aportsdir"

	if [ "$#" -eq 0 ]; then
		set -- tail -f /dev/null
	fi

	gitobld-docker -xe "$ABUILD_CONTAINER_NAME" $runargs "$ABUILD_IMAGE" $@
}

usage() {
	cat <<-EOF
		Usage: $program [-d PKG_DIRECTORY] PACKAGE...
		
		Build a Alpine package

		Options:
		    -b  Rebuild 'abuild' image
		    -d  Search for apks on this directory
		    -h  Show this help
		    -k  Set path to packager private key
		    -o  Set output directory
		    -p  Set path to packager public key
		    -r  Build APKBUILD dependencies
		    -U  Set user to run 'abuild' image
	EOF

	exit 0
}

while getopts "bd:hk:o:p:rU:" opt; do
	case $opt in
		b) rebuild_image_opt='-f' ;;
		d) PKG_DIRECTORY=$OPTARG ;;
		h) usage ;;
		k) PKG_PRIVKEY_PATH=$OPTARG ;;
		o) BUILD_OUTPUT_DIR=$OPTARG ;;
		p) PKG_PUBKEY_PATH=$OPTARG ;;
		r) build_deps_opt='-R' ;;
		U) container_user=$OPTARG ;;
	esac
done

shift $((OPTIND-1))

if [ "$#" -eq 0 ]; then
	die "No packages passed to '$program' command."
fi

[ "$1" = all ] && set -- $(gitobld-packages -P)

for pkg in $@; do
	if ! gitobld-packages -ae "$pkg"; then
		error "The package '$pkg' don't exists at ports directory."
		exit 1
	fi
done

if [ -n "$container_user" ]; then
	if ! id "$container_user" > /dev/null 2>&1; then
		die "User not found: $container_user"
	fi

	RUN_AS_USER="$(id -u $container_user):$(id -g $container_user)"
else
	RUN_AS_USER="$(id -u):$(id -g)"
fi

export RUN_AS_USER

msg "Building packages..."
abuild_run apk-build -t $build_deps_opt $@

